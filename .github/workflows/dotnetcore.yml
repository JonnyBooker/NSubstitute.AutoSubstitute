# Aspects of this code have been sourced from: https://github.com/moq/Moq.AutoMocker/blob/master/.github/workflows/dotnetcore.yml
name: Continuous Build Workflow

on:
  pull_request:

defaults:
  run:
    shell: pwsh

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3

    - name: Install Required Tools
      run: |
        dotnet new tool-manifest
        dotnet tool install dotnet-reportgenerator-globaltool
        dotnet tool install dotnet-coverage

    - name: .NET Build
      run: dotnet build --configuration "Release"

    - name: Run the unit tests with code coverage
      run: dotnet test --configuration "Release" --collect:"XPlat Code Coverage" --results-directory ./coverage
      #run: dotnet coverage collect dotnet test --output ./coverage/coverage.cobertura.xml --output-format cobertura

    - name: Generate Report
      run: |
        dotnet reportgenerator -reports:"**/coverage/**/coverage.cobertura.xml" -targetdir:"./coverage/coveragereport" -reporttypes:"MarkdownSummaryGithub;Html"

    - name: Upload code coverage report
      uses: actions/upload-artifact@v2
      with:
        name: coveragereport
        path: ./coverage/coveragereport

    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        header: "Coverage-Report"
        message: "Package Coverage Report"
        recreate: true
        path: ./coverage/coveragereport/SummaryGithub.md
